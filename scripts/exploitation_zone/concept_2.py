# -*- coding: utf-8 -*-
"""concept_2.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1cxJd7Dpixny4G6sSUqDPcGMVKydGrmwQ
"""

import duckdb
import pandas as pd
import numpy as np
import os
import re

from pathlib import Path


LACIUDADALDIA_TRUSTED_DIR = "trusted/laciudadaldia.parquet"
ARTICLES_TRUSTED_DIR = "trusted/articles/articles.csv"

EXPLOITATION_DIR = "exploitation/"
CONCEPT2_FILE = "concept2.parquet"

laciudadaldia = pd.read_parquet(LACIUDADALDIA_TRUSTED_DIR)
articles = pd.read_csv(ARTICLES_TRUSTED_DIR)

# Concept 2

# Coger las noticias que son realmente importantes, y sacar las estadisticas en base a ellas:
# IsRootEvent: Tells if the event is important.
# AvgGoldsteinScale: Mean of GoldsteinScale. Each CAMEO event code is assigned a numeric score from -10 to +10, capturing the theoretical potential impact that type of event will have on the stability of a country.
# Average of NumMentions, NumSources and NumArticles.
# Mean of AvgTone

filtered_table = articles[articles['IsRootEvent'] == 1]

# Lista de columnas para las cuales calcular el promedio
columns_to_average = ['GoldsteinScale', 'AvgTone', 'NumMentions', 'NumSources', 'NumArticles']

# Agrupar por 'date' y calcular el promedio para las columnas especificadas
averaged_data = filtered_table.groupby('SQLDATE')[columns_to_average].mean().reset_index()

df2 = pd.merge(averaged_data, laciudadaldia, left_on='SQLDATE', right_on='data_indicador', how='left')

# Si no quieres mantener la columna 'date2' despu√©s del merge (ya que es redundante), puedes eliminarla:
df2.drop('data_indicador', axis=1, inplace=True)

# Guardar en .parquet
df2.to_parquet(os.path.join(EXPLOITATION_DIR, CONCEPT2_FILE))